<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat - VAChat</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <script>window.userId = "<%= user && user._id ? user._id : '' %>";</script>

    <div class="chat-container">
        <header class="chat-header">
            <div class="user-info">
                <% if (user && user.avatar && user.avatar !=='/public/avatar.png' ) { %>
                    <img src="<%= user.avatar %>" alt="Avatar" class="avatar" />
                    <% } else { %>
                        <div class="avatar avatar-text">
                            <%= user && user.username ? user.username.substring(0,2).toUpperCase() : "US" %>
                        </div>
                        <% } %>
                            <span class="username">
                                <%= user && user.username ? user.username : "User" %>
                            </span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="notif-btn" title="Th√¥ng b√°o">
                    üîî
                    <span id="notif-badge" class="notif-badge" style="display:none;">0</span>
                </button>
                <div id="notif-dropdown" class="notif-dropdown" style="display:none;">
                    <div class="notif-header">Th√¥ng b√°o</div>
                    <div id="notif-list" class="notif-list"></div>
                    <div id="notif-empty" class="notif-empty">Kh√¥ng c√≥ th√¥ng b√°o</div>
                </div>
                <button class="icon-btn" title="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
                <form method="POST" action="/logout" class="logout-form" style="display:inline;">
                    <button type="submit">ƒêƒÉng xu·∫•t</button>
                </form>
            </div>
        </header>

        <div class="chat-body">
            <aside class="group-sidebar">
                <div class="group-sidebar-top">
                    <button id="private-chat-item" class="private-chat-item" data-tooltip="Tin nh·∫Øn ri√™ng t∆∞" aria-label="Tin nh·∫Øn ri√™ng t∆∞">üòâ</button>
                </div>
                <div class="group-separator" aria-hidden="true">‚Äî</div>
                <div class="group-list scrollable">
                    <h3>Nh√≥m chat</h3>
                    <ul id="groups">
                        <% (groups || []).forEach(group=> { %>
                            <% const gName = (group && group.name) ? String(group.name) : 'Group';
                               const gInitials = gName.trim().slice(0, 2).toUpperCase(); %>
                            <li class="chat-item" data-type="group" data-id="<%= group._id %>" data-group-name="<%= gName %>">
                                <span class="group-avatar" title="<%= gName %>"><%= gInitials || 'GC' %></span>
                                <span class="group-status-icon" aria-hidden="true">üîá</span>
                            </li>
                            <% }) %>
                    </ul>

                    <div class="group-create-wrap">
                        <button id="create-group-btn" class="group-create-btn" data-tooltip="T·∫°o nh√≥m Chat m·ªõi" aria-label="T·∫°o nh√≥m Chat m·ªõi">+</button>
                    </div>
                </div>
            </aside>

            <aside class="chat-sidebar">
                <div class="search-box">
                    <input type="text" id="search-user" placeholder="T√¨m b·∫°n..." autocomplete="off" />
                    <button id="search-btn">T√¨m</button>
                </div>

                <div class="friend-list">
                    <h3>B·∫°n b√®</h3>
                    <ul id="friends">
                        <% (friends || []).forEach(friend=> { %>
                            <li class="chat-item friend-profile" data-type="friend" data-id="<%= friend._id %>">
                                <span class="friend-avatar">
                                    <% if (friend.avatar && friend.avatar !=='/public/avatar.png' ) { %>
                                        <img src="<%= friend.avatar %>" class="avatar" style="width:32px;height:32px;">
                                        <% } else { %>
                                            <div class="avatar avatar-text" style="width:32px;height:32px;">
                                                <%= (friend.username||'').substring(0,2).toUpperCase() %>
                                            </div>
                                            <% } %>
                                    <span class="friend-presence-dot" aria-hidden="true"></span>
                                </span>
                                <span class="friend-username">
                                    <%= friend.username %>
                                </span>
                                <span class="friend-status-icon" aria-hidden="true"></span>
                            </li>
                            <% }) %>
                    </ul>
                </div>

                <div id="group-members-panel" class="group-members-panel" style="display:none;">
                    <h3>Th√†nh vi√™n trong nh√≥m</h3>
                    <ul id="group-members"></ul>
                </div>
            </aside>

            <main class="chat-main">
                <div id="chat-presence-bar" class="chat-presence-bar" style="display:none;">
                    <div class="chat-presence-left">
                        <span id="chat-presence-name" class="chat-presence-name"></span>
                    </div>
                    <div class="chat-presence-right">
                        <span id="chat-presence-dot" class="chat-presence-dot" aria-hidden="true"></span>
                        <span id="chat-presence-status" class="chat-presence-status"></span>
                    </div>
                </div>
                <div id="chat-box" style="position:relative;">
                    <div id="chat-placeholder" class="chat-placeholder">
                        <span>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</span>
                    </div>
                </div>

                <form id="chat-form">
                    <button type="button" id="emoji-btn" title="Emoji">üòä</button>
                    <div id="emoji-picker" style="display:none;"></div>
                    <input type="text" id="message" autocomplete="off" placeholder="Nh·∫≠p tin nh·∫Øn..." />


                    <button type="submit" id="send-btn" disabled>G·ª≠i</button>
                </form>
            </main>
        </div>
    </div>

    <!-- ensure create-group modal exists (hidden) -->
    <div id="create-group-modal"
        style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;">
        <div style="background:#23232a;padding:16px;border-radius:12px;min-width:320px;max-width:90vw;color:#e6f4ff;">
            <h3 style="margin:0 0 8px 0;color:#4f8cff;">T·∫°o nh√≥m m·ªõi</h3>
            <input id="group-name-input" placeholder="T√™n nh√≥m"
                style="width:100%;padding:8px;border-radius:8px;border:1px solid #23232a;margin-bottom:8px;background:#0d1114;color:#e6eef8;" />
            <div id="group-members-list" style="max-height:240px;overflow:auto;margin-bottom:8px;"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button id="create-group-cancel" class="btn"
                    style="background:#374151;color:#fff;padding:8px 12px;border-radius:8px;border:none;">H·ªßy</button>
                <button id="create-group-confirm" class="btn"
                    style="background:#4f8cff;color:#07101a;padding:8px 12px;border-radius:8px;border:none;">T·∫°o (√≠t
                    nh·∫•t 2 b·∫°n)</button>
            </div>
        </div>
    </div>

    <!-- add member modal (hidden) -->
    <div id="add-member-modal"
        style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;">
        <div style="background:#23232a;padding:16px;border-radius:12px;min-width:320px;max-width:90vw;color:#e6f4ff;">
            <h3 style="margin:0 0 8px 0;color:#4f8cff;">Th√™m b·∫°n b√® v√†o nh√≥m</h3>
            <div id="add-member-list" style="max-height:260px;overflow:auto;margin-bottom:8px;"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button id="add-member-cancel" class="btn"
                    style="background:#374151;color:#fff;padding:8px 12px;border-radius:8px;border:none;">H·ªßy</button>
                <button id="add-member-confirm" class="btn"
                    style="background:#4f8cff;color:#07101a;padding:8px 12px;border-radius:8px;border:none;">Th√™m</button>
            </div>
        </div>
    </div>

    <!-- group context menu -->
    <div id="group-context-menu" class="context-menu" style="display:none;">
        <button type="button" class="context-menu-item" data-action="mark-read">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>
        <button type="button" class="context-menu-item" data-action="toggle-mute">Im l·∫∑ng</button>
        <button type="button" class="context-menu-item" data-action="toggle-pin">Ghim</button>
        <button type="button" class="context-menu-item" data-action="add-member">Th√™m b·∫°n b√® v√†o nh√≥m</button>
        <div class="context-menu-divider"></div>
        <button type="button" class="context-menu-item danger" data-action="leave-group">R·ªùi nh√≥m chat</button>
    </div>

    <!-- friend context menu -->
    <div id="friend-context-menu" class="context-menu" style="display:none;">
        <button type="button" class="context-menu-item" data-action="mark-read">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>
        <button type="button" class="context-menu-item" data-action="toggle-mute">Im l·∫∑ng</button>
        <button type="button" class="context-menu-item" data-action="toggle-pin">Ghim üìé</button>
        <div class="context-menu-divider"></div>
        <button type="button" class="context-menu-item" data-action="delete-convo">X√≥a cu·ªôc tr√≤ chuy·ªán</button>
        <button type="button" class="context-menu-item danger" data-action="remove-friend">X√≥a b·∫°n b√®</button>
    </div>

    <!-- socket + ui modal lib -->
    <script src="/socket.io/socket.io.js"></script>
    <script type="module">
        import '/js/app.mjs';

        // Wait for app.mjs to initialize socketClient
        const socket = window.socketClient ? window.socketClient.socket : null;

        // helpers
        const chatPlaceholder = document.getElementById('chat-placeholder');

        // when sidebar item clicked we want quick UX hint for delete: (messages.mjs already opens convo)
        document.addEventListener('click', (e) => {
            const friendItem = e.target.closest('.chat-item.friend-profile');
            const groupItem = e.target.closest('.chat-item[data-type="group"]');
            if (friendItem) {
                if (chatPlaceholder) chatPlaceholder.style.display = 'none';
                return;
            }
            if (groupItem) {
                if (chatPlaceholder) chatPlaceholder.style.display = 'none';
                return;
            }
        });

        // delete current conversation (friend or group)
        async function doDeleteConversation(chatType, chatId) {
            if (!chatType || !chatId) return;
            const ok = window.UI && window.UI.confirm ? await window.UI.confirm('X√≥a cu·ªôc tr√≤ chuy·ªán s·∫Ω x√≥a to√†n b·ªô tin nh·∫Øn. B·∫°n ch·∫Øc ch·∫Øn?') : confirm('X√≥a cu·ªôc tr√≤ chuy·ªán s·∫Ω x√≥a to√†n b·ªô tin nh·∫Øn. B·∫°n ch·∫Øc ch·∫Øn?');
            if (!ok) return;
            try {
                const r = await fetch('/api/messages/delete-conversation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ chatType, chatId })
                });
                if (r.status === 401) return window.location.href = '/login';
                const j = await r.json();
                if (j && j.success) {
                    const chatBox = document.getElementById('chat-box');
                    if (chatBox) chatBox.innerHTML = '<div class="system-message">B·∫°n ƒë√£ x√≥a cu·ªôc tr√≤ chuy·ªán n√†y.</div>';
                    window.VAChat = window.VAChat || {};
                    window.VAChat.currentChat = null;
                    const li = document.querySelector(`.chat-item[data-id="${chatId}"]`);
                    if (li) li.classList.remove('active');
                } else {
                    if (window.UI && window.UI.alert) await window.UI.alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i'); else alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i');
                }
            } catch (err) {
                console.error(err);
                if (window.UI && window.UI.alert) await window.UI.alert('L·ªói khi x√≥a cu·ªôc tr√≤ chuy·ªán'); else alert('L·ªói khi x√≥a cu·ªôc tr√≤ chuy·ªán');
            }
        }
        // delete button removed

        // delete group conversation (per-group button in sidebar) ‚Äî DELETE ENTIRE GROUP
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.delete-group-btn');
            if (!btn) return;
            e.stopPropagation();
            const groupId = btn.dataset.id;
            if (!groupId) return;
            const ok = window.UI && window.UI.confirm ? await window.UI.confirm('X√≥a nh√≥m s·∫Ω x√≥a nh√≥m v√† to√†n b·ªô tin nh·∫Øn. B·∫°n ch·∫Øc ch·∫Øn?') : confirm('X√≥a nh√≥m s·∫Ω x√≥a nh√≥m v√† to√†n b·ªô tin nh·∫Øn. B·∫°n ch·∫Øc ch·∫Øn?');
            if (!ok) return;
            try {
                const r = await fetch('/api/groups/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ groupId })
                });
                if (r.status === 401) return window.location.href = '/login';
                const j = await r.json();
                if (j && j.success) {
                    // remove group item from sidebar
                    const li = document.querySelector(`.chat-item[data-type="group"][data-id="${groupId}"]`);
                    if (li && li.parentNode) li.parentNode.removeChild(li);
                    // if this group was active, clear chat and state
                    const active = document.querySelector('.chat-item.active[data-type="group"][data-id="' + groupId + '"]');
                    if (active) {
                        const chatBox = document.getElementById('chat-box');
                        if (chatBox) chatBox.innerHTML = '<div class="system-message">Nh√≥m ƒë√£ b·ªã x√≥a.</div>';
                        window.VAChat = window.VAChat || {};
                        window.VAChat.currentChat = null;
                    }
                    if (window.UI && window.UI.alert) await window.UI.alert('X√≥a nh√≥m th√†nh c√¥ng');
                } else {
                    if (window.UI && window.UI.alert) await window.UI.alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i'); else alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i');
                }
            } catch (err) {
                console.error(err);
                if (window.UI && window.UI.alert) await window.UI.alert('L·ªói khi x√≥a nh√≥m'); else alert('L·ªói khi x√≥a nh√≥m');
            }
        });

        // Create group modal wiring (uses existing DOM ids)
        (function () {
            const openBtn = document.getElementById('create-group-btn');
            const modal = document.getElementById('create-group-modal');
            const cancel = document.getElementById('create-group-cancel');
            const confirm = document.getElementById('create-group-confirm');
            const membersList = document.getElementById('group-members-list');
            const nameInput = document.getElementById('group-name-input');

            function buildMembers() {
                if (!membersList) return;
                membersList.innerHTML = '';
                document.querySelectorAll('.chat-item.friend-profile').forEach(li => {
                    const id = li.dataset.id;
                    const username = li.querySelector('.friend-username') ? li.querySelector('.friend-username').textContent : id;
                    const row = document.createElement('div');
                    row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.justifyContent = 'space-between';
                    row.style.padding = '6px 8px';
                    row.innerHTML = `<label style="display:flex;gap:8px;align-items:center;"><input type="checkbox" data-id="${id}" /> <span style="color:#cfe7ff">${username}</span></label>`;
                    membersList.appendChild(row);
                });
            }

            if (openBtn) openBtn.addEventListener('click', () => {
                buildMembers();
                if (nameInput) nameInput.value = '';
                if (modal) modal.style.display = 'flex';
            });
            if (cancel) cancel.addEventListener('click', () => { if (modal) modal.style.display = 'none'; });

            if (confirm) confirm.addEventListener('click', async () => {
                const name = (nameInput && nameInput.value || '').trim();
                const selected = membersList ? Array.from(membersList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.dataset.id) : [];
                if (!name) { if (window.UI && window.UI.alert) await window.UI.alert('Nh·∫≠p t√™n nh√≥m'); else alert('Nh·∫≠p t√™n nh√≥m'); return; }
                if (!selected || selected.length < 2) { if (window.UI && window.UI.alert) await window.UI.alert('Ch·ªçn √≠t nh·∫•t 2 b·∫°n'); else alert('Ch·ªçn √≠t nh·∫•t 2 b·∫°n'); return; }
                confirm.disabled = true;
                try {
                    const r = await fetch('/api/groups', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ name, members: selected }) });
                    if (r.status === 401) return window.location.href = '/login';
                    const j = await r.json();
                    if (j && j.success && j.group) {
                        const ul = document.getElementById('groups');
                        if (ul) {
                            const li = document.createElement('li');
                            const gName = (j.group && j.group.name) ? String(j.group.name) : 'Group';
                            const gInitials = gName.trim().slice(0, 2).toUpperCase();
                            li.className = 'chat-item';
                            li.dataset.type = 'group';
                            li.dataset.id = String(j.group._id);
                            li.dataset.groupName = gName;

                            const avatar = document.createElement('span');
                            avatar.className = 'group-avatar';
                            avatar.title = gName;
                            avatar.textContent = gInitials || 'GC';

                            const status = document.createElement('span');
                            status.className = 'group-status-icon';
                            status.setAttribute('aria-hidden', 'true');
                            status.textContent = 'üîá';

                            li.appendChild(avatar);
                            li.appendChild(status);
                            ul.insertBefore(li, ul.firstChild);
                            li.click();
                            const s = window.socketClient && window.socketClient.socket;
                            if (s && s.emit) s.emit('join-group', String(j.group._id));
                        }
                        if (modal) modal.style.display = 'none';
                    } else {
                        if (window.UI && window.UI.alert) await window.UI.alert(j && j.error ? j.error : 'T·∫°o nh√≥m th·∫•t b·∫°i'); else alert(j && j.error ? j.error : 'T·∫°o nh√≥m th·∫•t b·∫°i');
                    }
                } catch (e) { console.error(e); if (window.UI && window.UI.alert) await window.UI.alert('L·ªói t·∫°o nh√≥m'); else alert('L·ªói t·∫°o nh√≥m'); }
                confirm.disabled = false;
            });
        })();
    </script>

