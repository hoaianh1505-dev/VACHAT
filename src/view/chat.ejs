<!DOCTYPE html>
<html>

<head>
    <title>Chat - AVChat</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <script>
        window.userId = "<%= user._id %>";
    </script>
    <div class="chat-container">
        <!-- Header -->
        <header class="chat-header">
            <div class="user-info">
                <% if (user && user.avatar && user.avatar !=='/public/avatar.png' ) { %>
                    <img src="<%= user.avatar %>" alt="Avatar" class="avatar" />
                    <% } else { %>
                        <div class="avatar avatar-text">
                            <%= user && user.username ? user.username.substring(0,2).toUpperCase() : "US" %>
                        </div>
                        <% } %>
                            <span class="username">
                                <%= user && user.username ? user.username : "User" %>
                            </span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" title="Th√¥ng b√°o">
                    üîî
                </button>
                <button class="icon-btn" title="C√†i ƒë·∫∑t">
                    ‚öôÔ∏è
                </button>
                <!-- Delete conversation button -->
                <form method="POST" action="/auth/logout" class="logout-form" style="display:inline;">
                    <button type="submit">ƒêƒÉng xu·∫•t</button>
                </form>
            </div>
        </header>
        <!-- Body: Sidebar + Main -->
        <div class="chat-body">
            <!-- Sidebar -->
            <aside class="chat-sidebar">
                <div class="search-box">
                    <input type="text" id="search-user" placeholder="T√¨m b·∫°n qua username..." autocomplete="off" />
                    <button id="search-btn">T√¨m</button>
                </div>
                <div class="friend-list">
                    <h3>B·∫°n b√®</h3>
                    <ul id="friends">
                        <!-- Render danh s√°ch b·∫°n b√® -->
                        <% (friends || []).forEach(friend=> { %>
                            <li class="chat-item friend-profile" data-type="friend" data-id="<%= friend._id %>">
                                <span class="friend-avatar">
                                    <% if (friend.avatar && friend.avatar !=='/public/avatar.png' ) { %>
                                        <img src="<%= friend.avatar %>" class="avatar" style="width:32px;height:32px;">
                                        <% } else { %>
                                            <div class="avatar avatar-text" style="width:32px;height:32px;">
                                                <%= friend.username.substring(0,2).toUpperCase() %>
                                            </div>
                                            <% } %>
                                </span>
                                <span class="friend-username">
                                    <%= friend.username %>
                                </span>
                                <button class="remove-friend-btn" data-id="<%= friend._id %>" title="X√≥a b·∫°n">
                                    <span class="remove-friend-icon">
                                        <!-- icon user remove ho·∫∑c ch·ªØ "X√≥a" -->
                                        üóëÔ∏è
                                    </span>
                                </button>
                            </li>
                            <% }) %>
                    </ul>
                </div>
                <div class="group-list">
                    <h3>Nh√≥m chat</h3>
                    <ul id="groups">
                        <!-- Render danh s√°ch nh√≥m -->
                        <% (groups || []).forEach(group=> { %>
                            <li class="chat-item" data-type="group" data-id="<%= group._id %>">
                                <%= group.name %>
                            </li>
                            <% }) %>
                    </ul>
                </div>
            </aside>
            <!-- Main -->
            <main class="chat-main">
                <div id="chat-box" style="position:relative;">
                    <!-- delete button moved inside the conversation -->
                    <button id="delete-convo-btn" title="X√≥a cu·ªôc tr√≤ chuy·ªán" class="icon-btn"
                        style="position:absolute; right:16px; top:16px; z-index:4; background:rgba(0,0,0,0.24); border:1px solid rgba(255,255,255,0.06);">
                        üóëÔ∏è
                    </button>
                    <!-- N·∫øu ch∆∞a ch·ªçn cu·ªôc tr√≤ chuy·ªán th√¨ hi·ªÉn th·ªã th√¥ng b√°o -->
                    <div id="chat-placeholder" class="chat-placeholder">
                        <span>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</span>
                    </div>
                </div>
                <form id="chat-form">
                    <button type="button" id="emoji-btn" title="Emoji">üòä</button>
                    <div id="emoji-picker" style="display:none;"></div>
                    <input type="text" id="message" autocomplete="off" placeholder="Nh·∫≠p tin nh·∫Øn..." />
                    <!-- AI suggestion button -->
                    <button type="button" id="ai-btn" title="G·ª£i √Ω AI"
                        style="background:#0ea5a4;color:#fff;border:none;border-radius:12px;padding:8px 12px;">ü§ñ G·ª£i
                        √Ω</button>
                    <button type="submit" id="send-btn" disabled>G·ª≠i</button>
                </form>
            </main>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script type="module" src="/js/app.mjs"></script>
    <script>
        // X·ª≠ l√Ω n√∫t x√≥a cu·ªôc tr√≤ chuy·ªán + l·∫Øng nghe socket 'conversation-deleted'
        (function () {
            const deleteBtn = document.getElementById('delete-convo-btn');
            const chatBox = document.getElementById('chat-box');
            const placeholder = document.getElementById('chat-placeholder');

            async function clearChatUI(message = 'Cu·ªôc tr√≤ chuy·ªán ƒë√£ b·ªã x√≥a.') {
                if (chatBox) {
                    chatBox.innerHTML = '';
                    const el = document.createElement('div');
                    el.className = 'system-message';
                    el.textContent = message;
                    chatBox.appendChild(el);
                }
                // reset current chat state if available
                if (window.AVChat) {
                    window.AVChat.currentChat = null;
                }
                // hide placeholder? keep message visible
                if (placeholder) placeholder.style.display = 'flex';
                // optionally remove active class on list
                document.querySelectorAll('.chat-item.friend-profile.active').forEach(n => n.classList.remove('active'));
            }

            if (deleteBtn) {
                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const current = window.AVChat && window.AVChat.currentChat;
                    if (!current || !current.id) return alert('Ch·ªçn cu·ªôc tr√≤ chuy·ªán tr∆∞·ªõc khi x√≥a.');
                    if (!confirm('X√≥a cu·ªôc tr√≤ chuy·ªán s·∫Ω x√≥a to√†n b·ªô tin nh·∫Øn trong ƒë·ªëi tho·∫°i n√†y. B·∫°n ch·∫Øc ch·∫Øn ch·ª©?')) return;
                    try {
                        const res = await fetch('/delete-conversation', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({ chatType: current.type, chatId: current.id })
                        });
                        if (res.status === 401) return window.location.href = '/login';
                        const j = await res.json();
                        if (j && j.success) {
                            clearChatUI('B·∫°n ƒë√£ x√≥a cu·ªôc tr√≤ chuy·ªán n√†y.');
                            // optionally remove the friend item unread/badge etc.
                            const li = document.querySelector(`.chat-item[data-id="${current.id}"]`);
                            if (li) li.classList.remove('active');
                        } else {
                            alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i');
                        }
                    } catch (err) {
                        console.error('delete convo err', err);
                        alert('L·ªói khi x√≥a cu·ªôc tr√≤ chuy·ªán');
                    }
                });
            }

            // socket listener: if other side deleted this conversation, clear UI
            try {
                const sock = (window && window.socketClient && window.socketClient.socket) ? window.socketClient.socket : (window.io ? io() : null);
                if (sock) {
                    sock.on('conversation-deleted', (data) => {
                        if (!data || !window.AVChat || !window.AVChat.currentChat) return;
                        const cur = window.AVChat.currentChat;
                        if (String(cur.type) === String(data.chatType) && String(cur.id) === String(data.chatId)) {
                            clearChatUI('Cu·ªôc tr√≤ chuy·ªán ƒë√£ b·ªã x√≥a.');
                        }
                    });
                }
            } catch (e) { /* noop */ }
        })();
    </script>

    <script>
        // X·ª≠ l√Ω n√∫t x√≥a b·∫°n (gi·ªØ nguy√™n)
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.remove-friend-btn').forEach(btn => {
                btn.onclick = async function (e) {
                    e.stopPropagation();
                    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫°n n√†y?')) {
                        const friendId = btn.dataset.id;
                        const res = await fetch('/remove-friend', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ friendId })
                        });
                        const result = await res.json();
                        if (result.success) {
                            btn.closest('.friend-profile').remove();
                        } else {
                            alert(result.error || 'L·ªói x√≥a b·∫°n!');
                        }
                    }
                };
            });
        });
    </script>
</body>

</html>