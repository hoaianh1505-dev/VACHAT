<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat - AVChat</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <script>window.userId = "<%= user && user._id ? user._id : '' %>";</script>

    <div class="chat-container">
        <header class="chat-header">
            <div class="user-info">
                <% if (user && user.avatar && user.avatar !=='/public/avatar.png' ) { %>
                    <img src="<%= user.avatar %>" alt="Avatar" class="avatar" />
                    <% } else { %>
                        <div class="avatar avatar-text">
                            <%= user && user.username ? user.username.substring(0,2).toUpperCase() : "US" %>
                        </div>
                        <% } %>
                            <span class="username">
                                <%= user && user.username ? user.username : "User" %>
                            </span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" title="Th√¥ng b√°o">üîî</button>
                <button class="icon-btn" title="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
                <form method="POST" action="/auth/logout" class="logout-form" style="display:inline;">
                    <button type="submit">ƒêƒÉng xu·∫•t</button>
                </form>
            </div>
        </header>

        <div class="chat-body">
            <aside class="chat-sidebar">
                <div class="search-box">
                    <input type="text" id="search-user" placeholder="T√¨m b·∫°n..." autocomplete="off" />
                    <button id="search-btn">T√¨m</button>
                </div>

                <div class="friend-list">
                    <h3>B·∫°n b√®</h3>
                    <ul id="friends">
                        <% (friends || []).forEach(friend=> { %>
                            <li class="chat-item friend-profile" data-type="friend" data-id="<%= friend._id %>">
                                <span class="friend-avatar">
                                    <% if (friend.avatar && friend.avatar !=='/public/avatar.png' ) { %>
                                        <img src="<%= friend.avatar %>" class="avatar" style="width:32px;height:32px;">
                                        <% } else { %>
                                            <div class="avatar avatar-text" style="width:32px;height:32px;">
                                                <%= (friend.username||'').substring(0,2).toUpperCase() %>
                                            </div>
                                            <% } %>
                                </span>
                                <span class="friend-username">
                                    <%= friend.username %>
                                </span>
                                <button class="remove-friend-btn" data-id="<%= friend._id %>"
                                    title="X√≥a b·∫°n">üóëÔ∏è</button>
                            </li>
                            <% }) %>
                    </ul>
                </div>

                <div class="group-list">
                    <h3>Nh√≥m chat</h3>
                    <ul id="groups">
                        <% (groups || []).forEach(group=> { %>
                            <li class="chat-item" data-type="group" data-id="<%= group._id %>">
                                <span style="flex:1;">
                                    <%= group.name %>
                                </span>
                                <button class="delete-group-btn" data-id="<%= group._id %>" title="X√≥a l·ªãch s·ª≠ nh√≥m"
                                    style="margin-left:8px;background:transparent;border:none;color:#ef4444;cursor:pointer;">üóëÔ∏è</button>
                            </li>
                            <% }) %>
                    </ul>
                </div>

                <div style="padding:0 24px 12px;">
                    <button id="create-group-btn" class="btn"
                        style="width:100%;padding:8px 12px;background:#7c3aed;color:#fff;border-radius:8px;border:none;">T·∫°o
                        nh√≥m m·ªõi</button>
                </div>
            </aside>

            <main class="chat-main">
                <div id="chat-box" style="position:relative;">
                    <div id="chat-placeholder" class="chat-placeholder">
                        <span>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</span>
                    </div>
                </div>

                <form id="chat-form">
                    <button type="button" id="emoji-btn" title="Emoji">üòä</button>
                    <div id="emoji-picker" style="display:none;"></div>
                    <input type="text" id="message" autocomplete="off" placeholder="Nh·∫≠p tin nh·∫Øn..." />
                    <!-- AI button removed (AI disabled) -->
                    <!-- Delete conversation button (inline with AI) -->
                    <button type="button" id="delete-convo-btn" title="X√≥a cu·ªôc tr√≤ chuy·ªán"
                        style="display:none;margin-right:8px;border-radius:12px;padding:8px 12px;border:none;background:#ef4444;color:#fff;cursor:pointer;">
                        üóëÔ∏è X√≥a
                    </button>

                    <button type="submit" id="send-btn" disabled>G·ª≠i</button>
                </form>
            </main>
        </div>
    </div>

    <!-- ensure create-group modal exists (hidden) -->
    <div id="create-group-modal"
        style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;">
        <div style="background:#23232a;padding:16px;border-radius:12px;min-width:320px;max-width:90vw;color:#e6f4ff;">
            <h3 style="margin:0 0 8px 0;color:#4f8cff;">T·∫°o nh√≥m m·ªõi</h3>
            <input id="group-name-input" placeholder="T√™n nh√≥m"
                style="width:100%;padding:8px;border-radius:8px;border:1px solid #23232a;margin-bottom:8px;background:#0d1114;color:#e6eef8;" />
            <div id="group-members-list" style="max-height:240px;overflow:auto;margin-bottom:8px;"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button id="create-group-cancel" class="btn"
                    style="background:#374151;color:#fff;padding:8px 12px;border-radius:8px;border:none;">H·ªßy</button>
                <button id="create-group-confirm" class="btn"
                    style="background:#4f8cff;color:#07101a;padding:8px 12px;border-radius:8px;border:none;">T·∫°o (√≠t
                    nh·∫•t 2 b·∫°n)</button>
            </div>
        </div>
    </div>

    <!-- socket + ui modal lib -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/ui.modals.js"></script>

    <script type="module">
        import { socket, register } from '/js/socket-client.mjs';
        import { initMessages } from '/js/messages.mjs';
        import { initFriends } from '/js/friends.mjs';

        // register socket and init modules
        if (window.userId) register(window.userId);
        initMessages({ socket });
        initFriends({ socket });

        // helpers
        const deleteBtn = document.getElementById('delete-convo-btn');
        const chatPlaceholder = document.getElementById('chat-placeholder');

        function showDeleteFor(chatType, chatId) {
            if (!deleteBtn) return;
            deleteBtn.dataset.chatType = chatType;
            deleteBtn.dataset.chatId = chatId;
            deleteBtn.style.display = 'inline-flex';
        }
        function hideDelete() {
            if (!deleteBtn) return;
            deleteBtn.dataset.chatType = '';
            deleteBtn.dataset.chatId = '';
            deleteBtn.style.display = 'none';
        }

        // when sidebar item clicked we want quick UX hint for delete: (messages.mjs already opens convo)
        document.addEventListener('click', (e) => {
            const friendItem = e.target.closest('.chat-item.friend-profile');
            const groupItem = e.target.closest('.chat-item[data-type="group"]');
            if (friendItem) {
                showDeleteFor('friend', friendItem.dataset.id);
                if (chatPlaceholder) chatPlaceholder.style.display = 'none';
                return;
            }
            if (groupItem) {
                showDeleteFor('group', groupItem.dataset.id);
                if (chatPlaceholder) chatPlaceholder.style.display = 'none';
                return;
            }
            // hide if clicked outside sidebar and delete button
            if (!e.target.closest('.chat-sidebar') && !e.target.closest('#delete-convo-btn')) {
                const active = document.querySelector('.chat-item.active');
                if (!active) hideDelete();
            }
        });

        // delete current conversation (friend or group)
        async function doDeleteConversation(chatType, chatId) {
            if (!chatType || !chatId) return;
            const ok = window.UI && window.UI.confirm ? await window.UI.confirm('X√≥a cu·ªôc tr√≤ chuy·ªán s·∫Ω x√≥a to√†n b·ªô tin nh·∫Øn. B·∫°n ch·∫Øc ch·∫Øn?') : confirm('X√≥a cu·ªôc tr√≤ chuy·ªán s·∫Ω x√≥a to√†n b·ªô tin nh·∫Øn. B·∫°n ch·∫Øc ch·∫Øn?');
            if (!ok) return;
            try {
                const r = await fetch('/api/messages/delete-conversation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ chatType, chatId })
                });
                if (r.status === 401) return window.location.href = '/login';
                const j = await r.json();
                if (j && j.success) {
                    const chatBox = document.getElementById('chat-box');
                    if (chatBox) chatBox.innerHTML = '<div class="system-message">B·∫°n ƒë√£ x√≥a cu·ªôc tr√≤ chuy·ªán n√†y.</div>';
                    hideDelete();
                    window.AVChat = window.AVChat || {};
                    window.AVChat.currentChat = null;
                    const li = document.querySelector(`.chat-item[data-id="${chatId}"]`);
                    if (li) li.classList.remove('active');
                } else {
                    if (window.UI && window.UI.alert) await window.UI.alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i'); else alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i');
                }
            } catch (err) {
                console.error(err);
                if (window.UI && window.UI.alert) await window.UI.alert('L·ªói khi x√≥a cu·ªôc tr√≤ chuy·ªán'); else alert('L·ªói khi x√≥a cu·ªôc tr√≤ chuy·ªán');
            }
        }
        if (deleteBtn) {
            deleteBtn.addEventListener('click', async (ev) => {
                ev.stopPropagation();
                const chatType = deleteBtn.dataset.chatType || (window.AVChat && window.AVChat.currentChat && window.AVChat.currentChat.type);
                const chatId = deleteBtn.dataset.chatId || (window.AVChat && window.AVChat.currentChat && window.AVChat.currentChat.id);
                await doDeleteConversation(chatType, chatId);
            });
        }

        // remove friend -> API
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.remove-friend-btn');
            if (!btn) return;
            e.stopPropagation();
            const friendId = btn.dataset.id;
            const ok = window.UI && window.UI.confirm ? await window.UI.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫°n n√†y?') : confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫°n n√†y?');
            if (!ok) return;
            try {
                const res = await fetch('/api/friends/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ friendId })
                });
                if (res.status === 401) return window.location.href = '/login';
                const jr = await res.json();
                if (jr && jr.success) {
                    const el = btn.closest('.friend-profile') || btn.closest('.chat-item.friend-profile');
                    if (el) el.remove();
                } else {
                    if (window.UI && window.UI.alert) await window.UI.alert(jr && jr.error ? jr.error : 'L·ªói x√≥a b·∫°n'); else alert(jr && jr.error ? jr.error : 'L·ªói x√≥a b·∫°n');
                }
            } catch (err) {
                console.error(err);
                if (window.UI && window.UI.alert) await window.UI.alert('L·ªói x√≥a b·∫°n'); else alert('L·ªói x√≥a b·∫°n');
            }
        });

        // delete group conversation (per-group button in sidebar) ‚Äî DELETE ENTIRE GROUP
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.delete-group-btn');
            if (!btn) return;
            e.stopPropagation();
            const groupId = btn.dataset.id;
            if (!groupId) return;
            const ok = window.UI && window.UI.confirm ? await window.UI.confirm('X√≥a nh√≥m s·∫Ω x√≥a nh√≥m v√† to√†n b·ªô tin nh·∫Øn. B·∫°n ch·∫Øc ch·∫Øn?') : confirm('X√≥a nh√≥m s·∫Ω x√≥a nh√≥m v√† to√†n b·ªô tin nh·∫Øn. B·∫°n ch·∫Øc ch·∫Øn?');
            if (!ok) return;
            try {
                const r = await fetch('/api/groups/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ groupId })
                });
                if (r.status === 401) return window.location.href = '/login';
                const j = await r.json();
                if (j && j.success) {
                    // remove group item from sidebar
                    const li = document.querySelector(`.chat-item[data-type="group"][data-id="${groupId}"]`);
                    if (li && li.parentNode) li.parentNode.removeChild(li);
                    // if this group was active, clear chat and state
                    const active = document.querySelector('.chat-item.active[data-type="group"][data-id="' + groupId + '"]');
                    if (active) {
                        const chatBox = document.getElementById('chat-box');
                        if (chatBox) chatBox.innerHTML = '<div class="system-message">Nh√≥m ƒë√£ b·ªã x√≥a.</div>';
                        hideDelete();
                        window.AVChat = window.AVChat || {};
                        window.AVChat.currentChat = null;
                    }
                    if (window.UI && window.UI.alert) await window.UI.alert('X√≥a nh√≥m th√†nh c√¥ng');
                } else {
                    if (window.UI && window.UI.alert) await window.UI.alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i'); else alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i');
                }
            } catch (err) {
                console.error(err);
                if (window.UI && window.UI.alert) await window.UI.alert('L·ªói khi x√≥a nh√≥m'); else alert('L·ªói khi x√≥a nh√≥m');
            }
        });

        // Create group modal wiring (uses existing DOM ids)
        (function () {
            const openBtn = document.getElementById('create-group-btn');
            const modal = document.getElementById('create-group-modal');
            const cancel = document.getElementById('create-group-cancel');
            const confirm = document.getElementById('create-group-confirm');
            const membersList = document.getElementById('group-members-list');
            const nameInput = document.getElementById('group-name-input');

            function buildMembers() {
                if (!membersList) return;
                membersList.innerHTML = '';
                document.querySelectorAll('.chat-item.friend-profile').forEach(li => {
                    const id = li.dataset.id;
                    const username = li.querySelector('.friend-username') ? li.querySelector('.friend-username').textContent : id;
                    const row = document.createElement('div');
                    row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.justifyContent = 'space-between';
                    row.style.padding = '6px 8px';
                    row.innerHTML = `<label style="display:flex;gap:8px;align-items:center;"><input type="checkbox" data-id="${id}" /> <span style="color:#cfe7ff">${username}</span></label>`;
                    membersList.appendChild(row);
                });
            }

            if (openBtn) openBtn.addEventListener('click', () => {
                buildMembers();
                if (nameInput) nameInput.value = '';
                if (modal) modal.style.display = 'flex';
            });
            if (cancel) cancel.addEventListener('click', () => { if (modal) modal.style.display = 'none'; });

            if (confirm) confirm.addEventListener('click', async () => {
                const name = (nameInput && nameInput.value || '').trim();
                const selected = membersList ? Array.from(membersList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.dataset.id) : [];
                if (!name) { if (window.UI && window.UI.alert) await window.UI.alert('Nh·∫≠p t√™n nh√≥m'); else alert('Nh·∫≠p t√™n nh√≥m'); return; }
                if (!selected || selected.length < 2) { if (window.UI && window.UI.alert) await window.UI.alert('Ch·ªçn √≠t nh·∫•t 2 b·∫°n'); else alert('Ch·ªçn √≠t nh·∫•t 2 b·∫°n'); return; }
                confirm.disabled = true;
                try {
                    const r = await fetch('/api/groups', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ name, members: selected }) });
                    if (r.status === 401) return window.location.href = '/login';
                    const j = await r.json();
                    if (j && j.success && j.group) {
                        const ul = document.getElementById('groups');
                        if (ul) {
                            const li = document.createElement('li');
                            li.className = 'chat-item';
                            li.dataset.type = 'group';
                            li.dataset.id = String(j.group._id);
                            li.innerHTML = `<span style="flex:1;">${j.group.name}</span><button class="delete-group-btn" data-id="${j.group._id}" title="X√≥a l·ªãch s·ª≠ nh√≥m" style="margin-left:8px;background:transparent;border:none;color:#ef4444;cursor:pointer;">üóëÔ∏è</button>`;
                            ul.insertBefore(li, ul.firstChild);
                            li.click();
                            if (socket && socket.emit) socket.emit('join-group', String(j.group._id));
                        }
                        if (modal) modal.style.display = 'none';
                    } else {
                        if (window.UI && window.UI.alert) await window.UI.alert(j && j.error ? j.error : 'T·∫°o nh√≥m th·∫•t b·∫°i'); else alert(j && j.error ? j.error : 'T·∫°o nh√≥m th·∫•t b·∫°i');
                    }
                } catch (e) { console.error(e); if (window.UI && window.UI.alert) await window.UI.alert('L·ªói t·∫°o nh√≥m'); else alert('L·ªói t·∫°o nh√≥m'); }
                confirm.disabled = false;
            });
        })();
    </script>

    <!-- ...existing closing body/html if any ... -->