<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat - AVChat</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <script>window.userId = "<%= user && user._id ? user._id : '' %>";</script>

    <div class="chat-container">
        <header class="chat-header">
            <div class="user-info">
                <% if (user && user.avatar && user.avatar !=='/public/avatar.png' ) { %>
                    <img src="<%= user.avatar %>" alt="Avatar" class="avatar" />
                    <% } else { %>
                        <div class="avatar avatar-text">
                            <%= user && user.username ? user.username.substring(0,2).toUpperCase() : "US" %>
                        </div>
                        <% } %>
                            <span class="username">
                                <%= user && user.username ? user.username : "User" %>
                            </span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" title="Th√¥ng b√°o">üîî</button>
                <button class="icon-btn" title="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
                <form method="POST" action="/auth/logout" class="logout-form" style="display:inline;">
                    <button type="submit">ƒêƒÉng xu·∫•t</button>
                </form>
            </div>
        </header>

        <div class="chat-body">
            <aside class="chat-sidebar">
                <div class="search-box">
                    <input type="text" id="search-user" placeholder="T√¨m b·∫°n..." autocomplete="off" />
                    <button id="search-btn">T√¨m</button>
                </div>

                <div class="friend-list">
                    <h3>B·∫°n b√®</h3>
                    <ul id="friends">
                        <% (friends || []).forEach(friend=> { %>
                            <li class="chat-item friend-profile" data-type="friend" data-id="<%= friend._id %>">
                                <span class="friend-avatar">
                                    <% if (friend.avatar && friend.avatar !=='/public/avatar.png' ) { %>
                                        <img src="<%= friend.avatar %>" class="avatar" style="width:32px;height:32px;">
                                        <% } else { %>
                                            <div class="avatar avatar-text" style="width:32px;height:32px;">
                                                <%= (friend.username||'').substring(0,2).toUpperCase() %>
                                            </div>
                                            <% } %>
                                </span>
                                <span class="friend-username">
                                    <%= friend.username %>
                                </span>
                                <button class="remove-friend-btn" data-id="<%= friend._id %>"
                                    title="X√≥a b·∫°n">üóëÔ∏è</button>
                            </li>
                            <% }) %>
                    </ul>
                </div>

                <div class="group-list">
                    <h3>Nh√≥m chat</h3>
                    <ul id="groups">
                        <% (groups || []).forEach(group=> { %>
                            <li class="chat-item" data-type="group" data-id="<%= group._id %>">
                                <%= group.name %>
                            </li>
                            <% }) %>
                    </ul>
                </div>
            </aside>

            <main class="chat-main">
                <div id="chat-box" style="position:relative;">
                    <div id="chat-placeholder" class="chat-placeholder">
                        <span>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</span>
                    </div>
                </div>

                <form id="chat-form">
                    <button type="button" id="emoji-btn" title="Emoji">üòä</button>
                    <div id="emoji-picker" style="display:none;"></div>
                    <input type="text" id="message" autocomplete="off" placeholder="Nh·∫≠p tin nh·∫Øn..." />
                    <button type="button" id="ai-btn" title="G·ª£i √Ω AI"
                        style="background:#0ea5a4;color:#fff;border:none;border-radius:12px;padding:8px 12px;margin-right:8px;">ü§ñ
                        G·ª£i √Ω</button>

                    <!-- Delete conversation button (inline with AI) -->
                    <button type="button" id="delete-convo-btn" title="X√≥a cu·ªôc tr√≤ chuy·ªán"
                        style="display:none;margin-right:8px;border-radius:12px;padding:8px 12px;border:none;background:#ef4444;color:#fff;cursor:pointer;">
                        üóëÔ∏è X√≥a
                    </button>

                    <button type="submit" id="send-btn" disabled>G·ª≠i</button>
                </form>
            </main>
        </div>
    </div>

    <!-- socket + ui modal lib -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/ui.modals.js"></script>

    <script type="module">
        import { socket, register } from '/js/socket-client.mjs';
        import { initMessages } from '/js/messages.mjs';
        import { initFriends } from '/js/friends.mjs';

        // register socket if user present
        if (window.userId) register(window.userId);

        // init modules
        initMessages({ socket });
        initFriends({ socket });

        // delete button helpers
        const deleteBtn = document.getElementById('delete-convo-btn');
        const chatPlaceholder = document.getElementById('chat-placeholder');

        function showDeleteFor(chatType, chatId) {
            if (!deleteBtn) return;
            deleteBtn.dataset.chatType = chatType;
            deleteBtn.dataset.chatId = chatId;
            deleteBtn.style.display = 'inline-flex';
        }
        function hideDelete() {
            if (!deleteBtn) return;
            deleteBtn.dataset.chatType = '';
            deleteBtn.dataset.chatId = '';
            deleteBtn.style.display = 'none';
        }

        // show delete when sidebar item clicked (quick UX)
        document.addEventListener('click', (e) => {
            const friendItem = e.target.closest('.chat-item.friend-profile');
            const groupItem = e.target.closest('.chat-item[data-type="group"]');
            if (friendItem) {
                showDeleteFor('friend', friendItem.dataset.id);
                if (chatPlaceholder) chatPlaceholder.style.display = 'none';
                return;
            }
            if (groupItem) {
                showDeleteFor(groupItem.dataset.type || 'group', groupItem.dataset.id);
                if (chatPlaceholder) chatPlaceholder.style.display = 'none';
                return;
            }
            // hide if clicked outside sidebar and no active chat
            if (!e.target.closest('.chat-sidebar') && !e.target.closest('#delete-convo-btn')) {
                const active = document.querySelector('.chat-item.active');
                if (!active) hideDelete();
            }
        });

        // also ensure delete shows when messages module opens conversation
        window.addEventListener('conversation-opened', (ev) => {
            try {
                const d = ev && ev.detail;
                if (d && d.chatType && d.chatId) showDeleteFor(d.chatType, d.chatId);
            } catch (e) { /* noop */ }
        });

        // delete action
        if (deleteBtn) {
            deleteBtn.addEventListener('click', async (ev) => {
                ev.stopPropagation();
                const chatType = deleteBtn.dataset.chatType || (window.AVChat && window.AVChat.currentChat && window.AVChat.currentChat.type);
                const chatId = deleteBtn.dataset.chatId || (window.AVChat && window.AVChat.currentChat && window.AVChat.currentChat.id);
                if (!chatType || !chatId) {
                    if (window.UI && window.UI.alert) await window.UI.alert('Ch·ªçn cu·ªôc tr√≤ chuy·ªán tr∆∞·ªõc khi x√≥a.');
                    else alert('Ch·ªçn cu·ªôc tr√≤ chuy·ªán tr∆∞·ªõc khi x√≥a.');
                    return;
                }
                const ok = window.UI && window.UI.confirm ? await window.UI.confirm('X√≥a cu·ªôc tr√≤ chuy·ªán s·∫Ω x√≥a to√†n b·ªô tin nh·∫Øn. B·∫°n ch·∫Øc ch·∫Øn?') : confirm('X√≥a cu·ªôc tr√≤ chuy·ªán s·∫Ω x√≥a to√†n b·ªô tin nh·∫Øn. B·∫°n ch·∫Øc ch·∫Øn?');
                if (!ok) return;
                try {
                    const r = await fetch('/delete-conversation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ chatType, chatId })
                    });
                    if (r.status === 401) return window.location.href = '/login';
                    const j = await r.json();
                    if (j && j.success) {
                        const chatBox = document.getElementById('chat-box');
                        if (chatBox) chatBox.innerHTML = '<div class="system-message">B·∫°n ƒë√£ x√≥a cu·ªôc tr√≤ chuy·ªán n√†y.</div>';
                        hideDelete();
                        window.AVChat = window.AVChat || {};
                        window.AVChat.currentChat = null;
                        const li = document.querySelector(`.chat-item[data-id="${chatId}"]`);
                        if (li) li.classList.remove('active');
                    } else {
                        if (window.UI && window.UI.alert) await window.UI.alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i');
                        else alert(j && j.error ? j.error : 'X√≥a th·∫•t b·∫°i');
                    }
                } catch (err) {
                    console.error(err);
                    if (window.UI && window.UI.alert) await window.UI.alert('L·ªói khi x√≥a cu·ªôc tr√≤ chuy·ªán');
                    else alert('L·ªói khi x√≥a cu·ªôc tr√≤ chuy·ªán');
                }
            });
        }

        // delegate remove friend
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.remove-friend-btn');
            if (!btn) return;
            e.stopPropagation();
            const friendId = btn.dataset.id;
            const ok = window.UI && window.UI.confirm ? await window.UI.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫°n n√†y?') : confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫°n n√†y?');
            if (!ok) return;
            try {
                const res = await fetch('/remove-friend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ friendId })
                });
                if (res.status === 401) return window.location.href = '/login';
                const jr = await res.json();
                if (jr && jr.success) {
                    const el = btn.closest('.friend-profile');
                    if (el) el.remove();
                } else {
                    if (window.UI && window.UI.alert) await window.UI.alert(jr && jr.error ? jr.error : 'L·ªói x√≥a b·∫°n');
                    else alert(jr && jr.error ? jr.error : 'L·ªói x√≥a b·∫°n');
                }
            } catch (err) {
                console.error(err);
                if (window.UI && window.UI.alert) await window.UI.alert('L·ªói x√≥a b·∫°n');
                else alert('L·ªói x√≥a b·∫°n');
            }
        });

        // listen server event to clear UI when conversation deleted remotely
        if (socket && socket.on) {
            socket.on('conversation-deleted', (data) => {
                if (!data) return;
                const cur = window.AVChat && window.AVChat.currentChat;
                if (cur && String(cur.type) === String(data.chatType) && String(cur.id) === String(data.chatId)) {
                    const chatBox = document.getElementById('chat-box');
                    if (chatBox) chatBox.innerHTML = '<div class="system-message">Cu·ªôc tr√≤ chuy·ªán ƒë√£ b·ªã x√≥a.</div>';
                    hideDelete();
                    window.AVChat.currentChat = null;
                }
            });
        }
    </script>
</body>

</html>